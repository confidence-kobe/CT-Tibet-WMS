# 🧪 CT-Tibet-WMS 完整业务流程测试指南

## 📋 测试环境准备

**前端服务**: http://localhost:4447
**后端服务**: http://localhost:48888
**API文档**: http://localhost:48888/doc.html
**测试账号**: admin / admin123

**测试前确认**:
- ✅ 后端服务正常运行 (Spring Boot)
- ✅ 前端服务正常运行 (Vite)
- ✅ 数据库连接正常 (MySQL)
- ✅ 已有基础数据（物资、仓库、部门、用户）

---

## 🎯 核心业务流程测试（完整闭环）

### 测试场景1: 完整的申请→审批→出库→领取流程

这是系统的核心业务流程，必须完整测试。

#### Step 1: 准备基础数据

**测试用户**:
- 员工账号: 用于提交申请
- 仓管账号: admin / admin123

**必要数据**:
1. 至少1个启用的仓库
2. 至少3种启用的物资（有库存）
3. 至少1个部门

**操作步骤**:
```
1. 登录管理员账号
2. 【基础数据管理】→ 【仓库管理】
   - 创建测试仓库（如：总仓）
   - 确保状态=启用

3. 【基础数据管理】→ 【物资管理】
   - 创建3种测试物资
   - 记录物资编号和单价

4. 【入库管理】→ 【新建入库单】
   - 选择测试仓库
   - 添加3种物资，每种入库100个
   - 提交入库单

5. 验证库存是否增加
```

#### Step 2: 员工提交申请（员工角色）

**测试点**: 申请单创建、库存实时查询、数据验证

**操作步骤**:
```
1. 【申请管理】→ 【新建申请】
2. 填写表单:
   - 申请部门: 自动显示（当前用户部门）
   - 申请人: 自动显示（当前用户）
   - 目标仓库: 选择测试仓库
   - 申请原因: 输入"测试申请流程"

3. 添加申请明细:
   - 点击【添加物资】
   - 选择第1种物资，输入数量5
   - 查看库存是否正确显示（应为100）
   - 查看单价和金额是否自动计算

   - 再添加第2种物资，数量10
   - 再添加第3种物资，数量8

4. 查看合计金额是否正确
5. 点击【提交申请】
6. 确认提交对话框，点击【确认提交】
```

**预期结果**:
- ✅ 提示"申请提交成功，请等待仓管员审批"
- ✅ 自动跳转到【我的申请】列表
- ✅ 列表中显示刚提交的申请，状态=待审批

**记录数据**:
- 申请单号: ________
- 申请金额: ________

#### Step 3: 查看申请详情

**测试点**: 详情页字段映射、状态显示

**操作步骤**:
```
1. 在【我的申请】列表中，点击申请单号
2. 查看详情页信息是否完整:
   - 申请单号
   - 申请人、申请部门、申请时间
   - 目标仓库、申请原因
   - 申请明细（3条）
   - 合计金额
   - 状态=待审批

3. 验证【撤回申请】按钮是否显示
4. 验证【查看出库单】按钮不显示（因为还未审批）
```

**预期结果**:
- ✅ 所有字段显示正确
- ✅ 明细数量、单价、金额正确
- ✅ 可以撤回（先不撤回，继续测试）

#### Step 4: 仓管审批申请（仓管角色）

**测试点**: 审批流程、库存检查、拒绝理由验证

**操作步骤**:
```
1. 切换到管理员账号（仓管角色）
2. 【审批管理】→ 【待审批列表】
3. 查看刚才提交的申请是否出现在列表中

4. 测试拒绝流程（先测试拒绝，再测试通过）:
   - 点击【审批】按钮
   - 审批对话框显示完整信息
   - 点击【拒绝】
   - 不填拒绝理由，直接点击确定
   - 预期: 提示"请填写拒绝理由"

   - 填写拒绝理由"测试拒绝流程"
   - 点击确定
   - 预期: 提示"已拒绝"
   - 列表中该申请消失（移到已审批列表）

5. 验证已审批列表:
   - 【审批管理】→ 【已审批列表】
   - 筛选条件选择"已拒绝"
   - 查看刚才拒绝的申请
   - 拒绝理由显示正确

6. 让员工重新提交一个相同的申请（重复Step 2）
```

**预期结果**:
- ✅ 拒绝时必填拒绝理由
- ✅ 拒绝后申请状态=已拒绝
- ✅ 已审批列表可以查看拒绝记录

#### Step 5: 审批通过（关键流程）

**测试点**: 审批通过、自动创建出库单

**操作步骤**:
```
1. 【审批管理】→ 【待审批列表】
2. 找到员工重新提交的申请
3. 点击【审批】按钮
4. 审批对话框中:
   - 查看申请信息
   - 查看明细（3条）
   - 查看总金额

5. 点击【通过】
6. 预期: 提示"审批通过"
7. 列表中该申请消失

8. 验证已审批列表:
   - 【审批管理】→ 【已审批列表】
   - 筛选条件选择"已通过"
   - 查看刚才通过的申请
   - 审批人、审批时间显示正确
```

**预期结果**:
- ✅ 审批通过成功
- ✅ 申请状态=已通过
- ✅ 后端自动创建出库单（status=0，待领取）

**记录数据**:
- 出库单号: ________（后续在出库单列表查看）

#### Step 6: 员工查看审批结果

**测试点**: 申请详情更新、关联出库单链接

**操作步骤**:
```
1. 切换回员工账号
2. 【申请管理】→ 【我的申请】
3. 找到刚才的申请，状态应为"已通过"
4. 点击申请单号，查看详情

5. 验证详情页:
   - 状态=已通过
   - 审批人显示正确
   - 审批时间显示正确
   - 【撤回申请】按钮不再显示
   - 【查看出库单】按钮显示

6. 点击【查看出库单】
7. 预期: 跳转到出库单详情页
```

**预期结果**:
- ✅ 申请状态已更新
- ✅ 审批信息完整
- ✅ 可以查看关联的出库单
- ✅ 出库单状态=待领取

#### Step 7: 确认领取物资

**测试点**: 出库确认、库存扣减

**操作步骤**:
```
1. 在出库单详情页，记录当前信息:
   - 出库单号
   - 领取人
   - 物资明细
   - 状态=待领取

2. 点击【确认领取】按钮
3. 确认对话框，点击【确定】
4. 预期: 提示"确认领取成功"

5. 验证出库单状态更新:
   - 刷新页面
   - 状态应变为"已完成"
   - 【确认领取】按钮消失

6. 验证库存扣减:
   - 【库存管理】→ 【库存查询】
   - 查询测试仓库的3种物资
   - 库存应该分别减少 5、10、8
```

**预期结果**:
- ✅ 确认领取成功
- ✅ 出库单状态=已完成
- ✅ 库存正确扣减
- ✅ 完整业务流程闭环

#### Step 8: 验证申请单最终状态

**测试点**: 申请单状态流转完整性

**操作步骤**:
```
1. 【申请管理】→ 【我的申请】
2. 查看刚才的申请
3. 状态应为"已完成"（因为出库单已完成）

4. 点击查看详情
5. 验证:
   - 状态=已完成
   - 出库单号显示
   - 可以查看出库单
   - 所有时间节点完整
```

**预期结果**:
- ✅ 申请单状态=已完成
- ✅ 完整的状态流转: 待审批 → 已通过 → 已完成

---

## 🔍 异常场景测试

### 测试场景2: 库存不足时的审批流程

**目的**: 验证库存检查功能

**操作步骤**:
```
1. 员工提交申请，申请数量超过当前库存
   - 如：某物资库存50，申请100

2. 仓管审批时:
   - 系统检查库存不足
   - 显示警告提示
   - 仓管可以选择:
     a) 仍然通过审批（确认对话框）
     b) 拒绝审批
```

**预期结果**:
- ✅ 库存不足时有明确提示
- ✅ 仓管可以决定是否通过
- ✅ 审批通过后仍创建出库单（待补货后领取）

### 测试场景3: 撤回申请

**目的**: 验证撤回功能

**操作步骤**:
```
1. 员工提交申请（状态=待审批）
2. 在【我的申请】列表或详情页
3. 点击【撤回】按钮
4. 确认撤回
```

**预期结果**:
- ✅ 提示"撤回成功"
- ✅ 申请状态=已取消
- ✅ 待审批列表中不再显示该申请
- ✅ 已审批、已完成状态的申请不能撤回

### 测试场景4: 直接出库流程（仓管）

**目的**: 验证仓管直接出库（无需审批）

**操作步骤**:
```
1. 登录仓管账号
2. 【出库管理】→ 【直接出库】
3. 填写表单:
   - 选择仓库
   - 领取人姓名
   - 领取人电话
   - 出库类型（如：生产领用）
   - 出库原因

4. 添加出库明细
5. 提交出库单

6. 验证:
   - 出库单创建成功
   - 来源=直接出库
   - 状态=待领取
```

**预期结果**:
- ✅ 直接出库不需要审批
- ✅ 立即创建出库单
- ✅ 后续领取流程与申请出库相同

---

## 📊 数据验证检查点

### 检查点1: 字段映射正确性

**申请单字段**:
- [ ] `applyNo` 申请单号
- [ ] `applicantName` 申请人
- [ ] `applyTime` 申请时间
- [ ] `applyReason` 申请原因
- [ ] `approverName` 审批人
- [ ] `approvalTime` 审批时间
- [ ] `rejectReason` 拒绝理由（拒绝时）
- [ ] `outboundNo` 出库单号（通过后）

**出库单字段**:
- [ ] `outboundNo` 出库单号
- [ ] `receiverName` 领取人
- [ ] `outboundTime` 出库时间
- [ ] `source` 来源（1=直接出库, 2=申请出库）

### 检查点2: 状态流转正确性

**申请单状态**:
- [ ] 0: 待审批（新建）
- [ ] 1: 已通过（审批通过）
- [ ] 2: 已拒绝（审批拒绝）
- [ ] 3: 已完成（出库完成）
- [ ] 4: 已取消（用户撤回）

**出库单状态**:
- [ ] 0: 待领取（创建后）
- [ ] 1: 已完成（确认领取）
- [ ] 2: 已取消

### 检查点3: 权限控制

**员工权限**:
- [ ] 可以创建申请
- [ ] 可以查看自己的申请
- [ ] 可以撤回待审批的申请
- [ ] 不能审批申请
- [ ] 不能直接出库

**仓管权限**:
- [ ] 可以审批申请
- [ ] 可以直接出库
- [ ] 可以入库
- [ ] 可以查看所有申请

---

## 🐛 已知问题排查

### 问题1: 401未授权错误

**症状**: 登录后访问页面提示401
**排查**:
1. 检查localStorage中的token
2. 检查token是否过期
3. 重新登录

### 问题2: 分页数据为空

**症状**: 列表页面没有数据
**排查**:
1. 检查分页参数是否为`pageNum`和`pageSize`
2. 检查后端API返回格式
3. 检查数据库是否有数据

### 问题3: 字段显示undefined

**症状**: 某些字段显示为空或undefined
**排查**:
1. 查看浏览器Network标签，检查实际返回数据
2. 对照字段映射表
3. 检查后端VO字段名

### 问题4: 库存检查失败

**症状**: 选择物资后库存始终为0
**排查**:
1. 确认仓库已选择
2. 确认该仓库有该物资的库存记录
3. 检查inventory API调用参数

---

## ✅ 测试完成检查清单

### 功能完整性
- [ ] 员工可以提交申请
- [ ] 申请明细可以添加/删除
- [ ] 库存实时显示正确
- [ ] 金额自动计算正确
- [ ] 仓管可以查看待审批列表
- [ ] 仓管可以审批通过
- [ ] 仓管可以拒绝（必填理由）
- [ ] 审批通过后自动创建出库单
- [ ] 员工可以查看审批结果
- [ ] 员工可以查看关联出库单
- [ ] 出库单可以确认领取
- [ ] 确认领取后库存正确扣减
- [ ] 申请单状态流转正确
- [ ] 员工可以撤回待审批申请

### 数据准确性
- [ ] 所有字段映射正确
- [ ] 时间格式正确
- [ ] 金额计算正确
- [ ] 库存计算正确
- [ ] 分页功能正常

### 用户体验
- [ ] 操作提示清晰
- [ ] 错误提示友好
- [ ] 加载状态显示
- [ ] 确认对话框适当
- [ ] 页面跳转流畅

---

## 📝 测试记录模板

**测试日期**: ____________
**测试人员**: ____________
**测试环境**:
- 前端版本: ______
- 后端版本: ______
- 数据库版本: MySQL ______

**测试结果**:
```
场景1: 完整申请审批流程
├─ Step 1: 准备基础数据 ☑️
├─ Step 2: 员工提交申请 ☑️
├─ Step 3: 查看申请详情 ☑️
├─ Step 4: 仓管审批申请 ☑️
├─ Step 5: 审批通过 ☑️
├─ Step 6: 员工查看审批结果 ☑️
├─ Step 7: 确认领取物资 ☑️
└─ Step 8: 验证申请单最终状态 ☑️

场景2: 库存不足审批 ☑️
场景3: 撤回申请 ☑️
场景4: 直接出库 ☑️
```

**发现的问题**:
1.
2.
3.

**建议改进**:
1.
2.
3.

---

**更新时间**: 2025-11-14
**适用版本**: v1.0（审批模块完成版）
