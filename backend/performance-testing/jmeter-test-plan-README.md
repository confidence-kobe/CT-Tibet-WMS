# JMeter性能测试指南

## 概述

本目录包含CT-Tibet-WMS系统的JMeter性能测试配置文件,用于模拟真实业务场景下的并发用户负载测试。

## 测试场景设计

### 用户角色分布 (基于实际业务比例)

| 角色 | 用户数 | 占比 | 主要操作 |
|------|--------|------|----------|
| 普通员工 | 35 | 70% | 查看库存、提交申请、查看我的申请 |
| 仓管员 | 10 | 20% | 审批申请、创建入库/出库、确认取货 |
| 管理员 | 5 | 10% | 查看统计报表、系统管理 |
| **总计** | **50** | **100%** | - |

### 测试场景权重

#### 场景1: 普通员工操作流程 (70%权重)
1. 登录系统 (1次)
2. 查看仪表盘 (2次)
3. 查询库存列表 (5次)
4. 查看库存详情 (3次)
5. 提交物资申请 (1次)
6. 查看我的申请 (3次)

#### 场景2: 仓管员操作流程 (20%权重)
1. 登录系统 (1次)
2. 查看仪表盘 (2次)
3. 查看待审批列表 (5次)
4. 审批申请 (2次)
5. 创建入库单 (1次)
6. 创建出库单 (1次)
7. 确认出库取货 (1次)
8. 查询库存列表 (3次)

#### 场景3: 管理员操作流程 (10%权重)
1. 登录系统 (1次)
2. 查看仪表盘 (3次)
3. 查看入库统计 (2次)
4. 查看出库统计 (2次)
5. 查看库存统计 (2次)
6. 导出统计报表 (1次)

## 测试配置文件

### 1. wms-load-test-50users.jmx
**描述**: 50并发用户负载测试
**并发数**: 50
**持续时间**: 10分钟
**加压方式**: 30秒内线性增加到50用户

### 2. wms-stress-test-100users.jmx
**描述**: 100并发用户压力测试
**并发数**: 100
**持续时间**: 5分钟
**加压方式**: 60秒内线性增加到100用户

### 3. wms-spike-test.jmx
**描述**: 峰值测试 (模拟突发流量)
**并发数**: 20 → 100 → 20
**持续时间**: 6分钟
**模式**: 突增突降

## 性能测试指标

### 关键性能指标 (KPI)

| 指标类型 | 目标值 | 警告阈值 | 说明 |
|---------|--------|---------|------|
| **平均响应时间** | < 1000ms | 1000-2000ms | 所有API的平均响应时间 |
| **P95响应时间** | < 2000ms | 2000-3000ms | 95%的请求响应时间 |
| **P99响应时间** | < 3000ms | 3000-5000ms | 99%的请求响应时间 |
| **吞吐量** | > 100 TPS | 50-100 TPS | 每秒事务数 |
| **错误率** | < 1% | 1-5% | 请求失败百分比 |
| **CPU使用率** | < 70% | 70-85% | 应用服务器CPU |
| **内存使用率** | < 75% | 75-90% | 应用服务器内存 |
| **数据库连接数** | < 15 | 15-18 | HikariCP最大20 |

### 分类性能目标

#### 查询类API
| API | 目标响应时间 | P95响应时间 |
|-----|-------------|------------|
| 登录 | < 300ms | < 500ms |
| 仪表盘统计 | < 500ms | < 1000ms |
| 库存列表 | < 800ms | < 1500ms |
| 入库单列表 | < 800ms | < 1500ms |
| 出库单列表 | < 800ms | < 1500ms |
| 申请单列表 | < 800ms | < 1500ms |
| 详情查询 | < 300ms | < 500ms |

#### 统计类API
| API | 目标响应时间 | P95响应时间 |
|-----|-------------|------------|
| 入库统计 | < 2000ms | < 3000ms |
| 出库统计 | < 2000ms | < 3000ms |
| 库存统计 | < 2000ms | < 3000ms |

#### 写入类API
| API | 目标响应时间 | P95响应时间 |
|-----|-------------|------------|
| 创建申请 | < 500ms | < 1000ms |
| 审批申请 | < 500ms | < 1000ms |
| 创建入库 | < 800ms | < 1500ms |
| 创建出库 | < 800ms | < 1500ms |
| 确认出库 | < 500ms | < 1000ms |

## 测试前准备

### 1. 数据准备
```sql
-- 确保有足够的测试数据
-- 物资: 至少100条
-- 仓库: 至少14个
-- 用户: 至少50个 (35普通员工 + 10仓管员 + 5管理员)
-- 库存: 至少500条
-- 历史单据: 入库单200+, 出库单200+, 申请单300+

-- 执行数据初始化脚本
source backend/database/test_data_generator.sql;
```

### 2. 系统准备
```bash
# 确保服务正常运行
# MySQL数据库
# Redis缓存
# Spring Boot应用

# 检查服务状态
curl http://localhost:48888/actuator/health
```

### 3. JMeter安装
```bash
# 下载JMeter (需要Java 8+)
wget https://dlcdn.apache.org/jmeter/binaries/apache-jmeter-5.6.3.tgz
tar -xzf apache-jmeter-5.6.3.tgz
cd apache-jmeter-5.6.3

# 安装插件管理器
wget -O lib/ext/jmeter-plugins-manager.jar \
  https://jmeter-plugins.org/get/

# 安装必要插件
# - Custom Thread Groups
# - Transactions Per Second
# - Response Times Over Time
```

## 执行测试

### GUI模式 (开发调试)
```bash
# 启动JMeter GUI
./bin/jmeter.sh

# 打开测试计划
# File → Open → 选择 wms-load-test-50users.jmx

# 配置测试参数
# - 服务器地址: localhost
# - 端口: 48888
# - 协议: http

# 运行测试
# 点击 "Start" 按钮

# 查看结果
# - View Results Tree
# - Summary Report
# - Aggregate Report
```

### 命令行模式 (正式测试,推荐)
```bash
# 50并发用户负载测试
./bin/jmeter.sh -n -t ../backend/performance-testing/wms-load-test-50users.jmx \
  -l results/load-test-50users-$(date +%Y%m%d-%H%M%S).jtl \
  -e -o results/load-test-50users-report-$(date +%Y%m%d-%H%M%S) \
  -Jserver=localhost -Jport=48888

# 100并发用户压力测试
./bin/jmeter.sh -n -t ../backend/performance-testing/wms-stress-test-100users.jmx \
  -l results/stress-test-100users-$(date +%Y%m%d-%H%M%S).jtl \
  -e -o results/stress-test-100users-report-$(date +%Y%m%d-%H%M%S) \
  -Jserver=localhost -Jport=48888

# 峰值测试
./bin/jmeter.sh -n -t ../backend/performance-testing/wms-spike-test.jmx \
  -l results/spike-test-$(date +%Y%m%d-%H%M%S).jtl \
  -e -o results/spike-test-report-$(date +%Y%m%d-%H%M%S) \
  -Jserver=localhost -Jport=48888
```

### 参数说明
- `-n`: 非GUI模式
- `-t`: 测试计划文件路径
- `-l`: 结果日志文件路径 (JTL格式)
- `-e`: 测试结束后生成HTML报告
- `-o`: HTML报告输出目录
- `-J`: 传递自定义参数

## 测试结果分析

### 1. HTML报告
JMeter会自动生成HTML报告,包含:
- **Dashboard**: 整体性能概览
- **Response Times**: 响应时间分布
- **Throughput**: 吞吐量趋势
- **Errors**: 错误统计

### 2. 关键指标解读

#### Summary Report
```
Label                  | # Samples | Average | Min | Max  | Std. Dev. | Error % | Throughput
----------------------|-----------|---------|-----|------|-----------|---------|------------
登录                   | 1000      | 245ms   | 89  | 1203 | 156       | 0.00%   | 50.2/sec
查询库存列表           | 5000      | 687ms   | 201 | 2105 | 301       | 0.10%   | 125.5/sec
仪表盘统计             | 2000      | 423ms   | 156 | 1567 | 201       | 0.00%   | 75.3/sec
```

#### Aggregate Report
- **90% Line**: 90%的请求在此时间内完成
- **95% Line**: 95%的请求在此时间内完成
- **99% Line**: 99%的请求在此时间内完成

### 3. 性能瓶颈识别

#### 慢请求分析
```bash
# 提取超过2秒的请求
awk -F',' '$2 > 2000 {print $0}' results/load-test-50users-*.jtl | sort -t',' -k2 -nr | head -20
```

#### 错误日志分析
```bash
# 统计错误类型
grep "false" results/load-test-50users-*.jtl | cut -d',' -f4 | sort | uniq -c | sort -nr
```

## 性能优化验证流程

### 迭代测试流程
```
1. 基线测试 (优化前)
   ├─ 执行50并发测试
   ├─ 记录基线性能指标
   └─ 识别性能瓶颈

2. 应用优化 (实施优化方案)
   ├─ 创建数据库索引
   ├─ 实施Redis缓存
   ├─ 优化SQL查询
   └─ 调整连接池配置

3. 验证测试 (优化后)
   ├─ 执行相同的50并发测试
   ├─ 对比优化前后指标
   └─ 计算性能提升百分比

4. 压力测试
   ├─ 执行100并发压力测试
   ├─ 验证系统稳定性
   └─ 确定系统容量上限

5. 峰值测试
   ├─ 执行突发流量测试
   ├─ 验证自动扩展能力
   └─ 测试系统恢复能力
```

### 性能对比报告模板
```
┌─────────────────────────────────────────────────────────┐
│             性能测试对比报告                              │
├─────────────────────────────────────────────────────────┤
│ 测试场景: 50并发用户负载测试                              │
│ 测试时间: 2025-11-24                                      │
│ 优化内容: 数据库索引 + Redis缓存                          │
└─────────────────────────────────────────────────────────┘

指标对比:
┌──────────────┬───────────┬───────────┬──────────┐
│ 指标         │ 优化前    │ 优化后    │ 提升幅度 │
├──────────────┼───────────┼───────────┼──────────┤
│ 平均响应时间 │ 1587ms    │ 456ms     │ 71.2%    │
│ P95响应时间  │ 3201ms    │ 892ms     │ 72.1%    │
│ P99响应时间  │ 5103ms    │ 1567ms    │ 69.3%    │
│ 吞吐量       │ 78.5 TPS  │ 185.3 TPS │ 136.1%   │
│ 错误率       │ 2.3%      │ 0.1%      │ 95.7%    │
│ CPU使用率    │ 82%       │ 54%       │ 34.1%    │
└──────────────┴───────────┴───────────┴──────────┘

分类API性能对比:
┌────────────────┬─────────────────┬─────────────────┬──────────┐
│ API类型        │ 优化前平均响应  │ 优化后平均响应  │ 提升幅度 │
├────────────────┼─────────────────┼─────────────────┼──────────┤
│ 仪表盘统计     │ 2103ms          │ 287ms           │ 86.4%    │
│ 库存列表查询   │ 1567ms          │ 423ms           │ 73.0%    │
│ 统计报表       │ 4201ms          │ 892ms           │ 78.8%    │
│ 详情查询       │ 687ms           │ 156ms           │ 77.3%    │
└────────────────┴─────────────────┴─────────────────┴──────────┘

结论:
✓ 所有指标均达到或超过目标
✓ 平均响应时间降低71.2%
✓ 吞吐量提升136.1%
✓ 系统稳定性显著改善
```

## 持续监控

### 定期性能测试
```bash
# 建议每周执行一次基准测试
# 使用cron定时任务

# 编辑crontab
crontab -e

# 添加定时任务 (每周一凌晨2点执行)
0 2 * * 1 /opt/jmeter/bin/jmeter.sh -n -t /path/to/wms-load-test-50users.jmx \
  -l /var/log/jmeter/weekly-test-$(date +\%Y\%m\%d).jtl \
  -e -o /var/log/jmeter/weekly-report-$(date +\%Y\%m\%d)
```

### 性能趋势分析
建议使用InfluxDB + Grafana收集和可视化JMeter测试结果,实现性能趋势监控。

## 故障排查

### 常见问题

#### 1. 连接超时
```
错误: Connection timeout
原因: 并发数过高,数据库连接池耗尽
解决: 增加数据库连接池大小或降低并发数
```

#### 2. 内存溢出
```
错误: OutOfMemoryError
原因: 查询返回数据量过大
解决: 实施分页查询,限制单次查询数据量
```

#### 3. 缓存穿透
```
错误: 大量请求直达数据库
原因: 缓存未命中或缓存失效
解决: 检查Redis服务,优化缓存策略
```

## 参考资源

- [JMeter官方文档](https://jmeter.apache.org/usermanual/)
- [JMeter最佳实践](https://jmeter.apache.org/usermanual/best-practices.html)
- [性能测试艺术](https://www.oreilly.com/library/view/the-art-of/9781449377748/)
