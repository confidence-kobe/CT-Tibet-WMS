# Production Environment Configuration for CT-Tibet-WMS
# This configuration file is used in production environments
# All sensitive data should be managed via environment variables

spring:
  application:
    name: ct-tibet-wms

  profiles:
    active: prod

  # Data Source Configuration (Production)
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    # Database URL from environment variables
    url: ${SPRING_DATASOURCE_URL:jdbc:mysql://mysql:3306/ct_tibet_wms?useUnicode=true&characterEncoding=utf8mb4&serverTimezone=Asia/Shanghai&useSSL=false&allowPublicKeyRetrieval=true&cachePrepStmts=true&prepStmtCacheSize=250&prepStmtCacheSqlLimit=2048}
    username: ${SPRING_DATASOURCE_USERNAME:wms_user}
    password: ${SPRING_DATASOURCE_PASSWORD}
    type: com.zaxxer.hikari.HikariDataSource

    # HikariCP Connection Pool Configuration - Optimized for production
    hikari:
      pool-name: WmsHikariPool-Prod
      minimum-idle: ${SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE:5}
      maximum-pool-size: ${SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE:20}
      connection-timeout: ${SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT:30000}
      idle-timeout: ${SPRING_DATASOURCE_HIKARI_IDLE_TIMEOUT:600000}
      max-lifetime: ${SPRING_DATASOURCE_HIKARI_MAX_LIFETIME:1800000}
      auto-commit: true
      leak-detection-threshold: 60000
      connection-init-sql: "SELECT 1"
      data-source-properties:
        cachePrepStmts: true
        prepStmtCacheSize: 250
        prepStmtCacheSqlLimit: 2048
        useServerPrepStmts: true
        useLocalSessionState: true
        rewriteBatchedStatements: true
        cacheCallableStmts: true
        cacheServerConfiguration: true
        elideSetAutoCommits: true
        maintainTimeStats: false

  # Redis Cache Configuration (Production)
  redis:
    host: ${SPRING_REDIS_HOST:redis}
    port: ${SPRING_REDIS_PORT:6379}
    password: ${SPRING_REDIS_PASSWORD}
    database: ${SPRING_REDIS_DATABASE:0}
    timeout: ${SPRING_REDIS_TIMEOUT:3000}
    ssl: false

    # Lettuce Connection Pool - Production optimized
    lettuce:
      pool:
        max-active: ${SPRING_REDIS_LETTUCE_POOL_MAX_ACTIVE:8}
        max-idle: ${SPRING_REDIS_LETTUCE_POOL_MAX_IDLE:8}
        min-idle: ${SPRING_REDIS_LETTUCE_POOL_MIN_IDLE:0}
        max-wait: ${SPRING_REDIS_LETTUCE_POOL_MAX_WAIT:-1ms}
      shutdown-timeout: 2000ms

  # RabbitMQ Message Queue Configuration (Production)
  rabbitmq:
    host: ${SPRING_RABBITMQ_HOST:rabbitmq}
    port: ${SPRING_RABBITMQ_PORT:5672}
    username: ${SPRING_RABBITMQ_USERNAME:wms_admin}
    password: ${SPRING_RABBITMQ_PASSWORD}
    virtual-host: ${SPRING_RABBITMQ_VIRTUAL_HOST:/wms}
    connection-timeout: ${SPRING_RABBITMQ_CONNECTION_TIMEOUT:10000}

    # Publisher Confirmations - Ensure message delivery
    publisher-confirm-type: ${SPRING_RABBITMQ_PUBLISHER_CONFIRM_TYPE:correlated}
    publisher-returns: ${SPRING_RABBITMQ_PUBLISHER_RETURNS:true}

    # Connection Pool Configuration
    requested-heartbeat: 60
    requested-channel-max: 2048
    cache:
      channel:
        size: 50
      connection:
        mode: CONNECTION
        size: 5

    # Consumer/Listener Configuration
    listener:
      simple:
        acknowledge-mode: ${SPRING_RABBITMQ_LISTENER_SIMPLE_ACKNOWLEDGE_MODE:manual}
        prefetch: ${SPRING_RABBITMQ_LISTENER_SIMPLE_PREFETCH:1}
        # Retry Configuration - Support failed message retry
        retry:
          enabled: true
          initial-interval: 1000
          max-interval: 10000
          multiplier: 1.0
          max-attempts: 3
        # Default consumption timeout
        default-requeue-rejected: false
        # Concurrency settings
        concurrency: "1-10"
        max-concurrency: 10

  # Jackson JSON Configuration (Production)
  jackson:
    time-zone: Asia/Shanghai
    date-format: yyyy-MM-dd HH:mm:ss
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
      fail-on-empty-beans: false
    deserialization:
      fail-on-unknown-properties: false

  # File Upload Configuration (Production)
  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB
      max-request-size: 50MB

  # Servlet Configuration
  servlet-path: /

# MyBatis-Plus Configuration (Production)
mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  type-aliases-package: com.ct.wms.entity
  global-config:
    db-config:
      id-type: AUTO
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
      insert-strategy: not_null
      update-strategy: not_null
    banner: false
  configuration:
    # Use camelCase to underscore mapping
    map-underscore-to-camel-case: true
    cache-enabled: false
    # Production: Disable detailed SQL logging (use INFO level)
    log-impl: org.apache.ibatis.logging.noop.NoLoggingImpl
    default-fetch-size: 100
    default-statement-timeout: 30
    aggressive-lazy-loading: false
    lazy-loading-enabled: false
    multiple-result-sets-enabled: false

# JWT Configuration (Production)
jwt:
  secret: ${JWT_SECRET}
  expiration: ${JWT_EXPIRATION:7200}  # 2 hours
  refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800}  # 7 days
  issuer: ct-tibet-wms

# File Upload Configuration (Production)
file:
  upload-path: ${FILE_UPLOAD_PATH:/data/wms/uploads}
  max-size: ${FILE_MAX_SIZE:10485760}  # 10MB
  allowed-extensions: jpg,jpeg,png,gif,pdf,doc,docx,xls,xlsx

# Server Configuration (Production)
server:
  port: ${SERVER_PORT:48888}
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
    min-response-size: 1024
  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: never
    include-exception: false
  tomcat:
    uri-encoding: UTF-8
    threads:
      max: 200
      min-spare: 10
    connection-timeout: 30000
    accept-count: 100
    max-connections: 10000
  # Graceful shutdown configuration
  shutdown: graceful

spring.lifecycle.timeout-per-shutdown-phase: 30s

# Logging Configuration (Production)
# Detailed configurations are in logback-spring.xml
logging:
  config: classpath:logback-spring.xml
  level:
    root: INFO
    com.ct.wms: INFO
    com.baomidou.mybatisplus: WARN
    org.springframework.security: WARN
    org.springframework.web: WARN
    org.springframework.boot.actuate: INFO
  file:
    name: /app/logs/ct-wms.log
    max-size: 100MB
    max-history: 30
    total-size-cap: 10GB
    path: /app/logs

# Knife4j Swagger API Documentation
knife4j:
  enable: true
  setting:
    language: zh_cn
    swagger-model-name: 实体类列表
  production: true  # Production mode - disable by default in UI

# Spring Boot Actuator (Production)
# Used for health checks and metrics monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      show-components: when-authorized
      probes:
        enabled: true
  health:
    defaults:
      enabled: true
    livenessState:
      enabled: true
    readinessState:
      enabled: true
  metrics:
    enable:
      jvm: true
      process: true
      system: true
      logback: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
  prometheus:
    metrics:
      export:
        enabled: true

# Security Configuration (Production)
security:
  cors:
    allowed-origins: "*"
    allowed-methods: GET,POST,PUT,DELETE,OPTIONS
    allowed-headers: "*"
    allow-credentials: false
    max-age: 3600

# Application-specific Configuration
app:
  name: CT-Tibet-WMS
  version: 1.0.0
  environment: production
  timezone: Asia/Shanghai
