# CT-Tibet-WMS 小程序部署指南

本文档详细说明如何将小程序从开发环境部署到生产环境。

## 部署前准备

### 1. 微信小程序账号

**注册小程序账号：**
1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 点击"立即注册" → 选择"小程序"
3. 填写账号信息并完成注册
4. 完成主体信息认证（企业认证）

**获取 AppID：**
1. 登录微信公众平台
2. 进入"开发" → "开发管理" → "开发设置"
3. 复制 AppID

### 2. 开发者工具

**下载微信开发者工具：**
- 访问 [微信开发者工具下载页](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
- 下载对应操作系统的版本
- 安装并登录（需要小程序管理员扫码授权）

### 3. 服务器准备

**域名要求：**
- 必须是 HTTPS 协议
- 需要备案（针对国内服务器）
- 配置有效的 SSL 证书

**后端服务：**
- 确保后端 API 服务已部署并可访问
- 记录 API 基础地址（例如：`https://api.your-domain.com`）

## 配置步骤

### 步骤 1：修改项目配置

**1.1 配置 AppID**

编辑 `manifest.json`：
```json
{
  "mp-weixin": {
    "appid": "你的AppID",
    "setting": {
      "urlCheck": true
    }
  }
}
```

**1.2 配置 API 地址**

编辑 `utils/request.js`：
```javascript
// 修改生产环境 API 地址
const baseURL = 'https://api.your-domain.com'
```

**1.3 检查 pages.json**

确认页面路由和 TabBar 配置正确：
```json
{
  "pages": [...],
  "tabBar": {
    "list": [...]
  }
}
```

### 步骤 2：配置服务器域名

**2.1 登录微信公众平台**
1. 进入"开发" → "开发管理" → "开发设置"
2. 找到"服务器域名"配置

**2.2 配置合法域名**

添加以下域名（根据实际情况）：

- **request 合法域名**：
  ```
  https://api.your-domain.com
  ```

- **uploadFile 合法域名**（如有文件上传）：
  ```
  https://upload.your-domain.com
  ```

- **downloadFile 合法域名**（如有文件下载）：
  ```
  https://download.your-domain.com
  ```

**注意事项：**
- 域名必须是 HTTPS 协议
- 每月只能修改 5 次
- 配置后需要等待几分钟生效

### 步骤 3：准备静态资源

**3.1 TabBar 图标**

在 `static/tabbar/` 目录下放置以下图标：
- home.png / home-active.png
- apply.png / apply-active.png（员工）
- approval.png / approval-active.png（仓管）
- inventory.png / inventory-active.png
- quick.png / quick-active.png（仓管）
- mine.png / mine-active.png

**3.2 默认图片**

在 `static/images/` 目录下放置：
- default-avatar.png（默认头像）
- logo.png（Logo）

**临时方案：**
如图标未准备好，可使用文字代替，修改 `pages.json` 中的 tabBar 配置：
```json
{
  "tabBar": {
    "list": [
      {
        "text": "首页"
        // 暂时不配置 iconPath 和selectedIconPath
      }
    ]
  }
}
```

### 步骤 4：构建项目

**4.1 使用 HBuilderX**
1. 打开项目
2. 点击"发行" → "小程序-微信"
3. 填写小程序名称和 AppID
4. 点击"发行"

**4.2 使用命令行**
```bash
# 开发环境构建
npm run dev:mp-weixin

# 生产环境构建
npm run build:mp-weixin
```

构建产物位于 `dist/build/mp-weixin/` 目录。

### 步骤 5：上传代码

**5.1 打开微信开发者工具**
1. 选择"导入项目"
2. 选择项目目录（构建产物目录）
3. 填写 AppID
4. 点击"导入"

**5.2 预览测试**
1. 点击工具栏"预览"按钮
2. 扫描二维码在真机上测试
3. 测试所有功能是否正常

**5.3 上传代码**
1. 点击工具栏"上传"按钮
2. 填写版本号（例如：1.0.0）
3. 填写项目备注（例如：初始版本）
4. 点击"上传"

## 提交审核

### 步骤 1：配置体验版

**1.1 添加体验成员**
1. 登录微信公众平台
2. 进入"管理" → "成员管理" → "体验成员"
3. 添加测试人员的微信号
4. 测试人员扫码体验

**1.2 体验版测试**
- 完整测试所有功能流程
- 确认数据交互正常
- 检查页面显示效果
- 验证权限控制

### 步骤 2：提交审核

**2.1 进入版本管理**
1. 登录微信公众平台
2. 进入"管理" → "版本管理"
3. 找到开发版本

**2.2 提交审核**
1. 点击"提交审核"按钮
2. 配置审核信息：

**填写基本信息：**
- **功能页面**：选择首页和主要功能页面
- **服务类目**：选择"企业管理 - 办公 OA"
- **标签**：仓库管理、物资管理、审批

**填写测试账号：**
```
员工账号：
账号：employee_test
密码：Test@123
说明：普通员工，可提交申请、查询库存

仓管账号：
账号：warehouse_test
密码：Test@123
说明：仓库管理员，可审批、入库、出库
```

**功能说明：**
```
西藏电信仓库管理系统，用于内部物资申请、审批、出入库管理。

主要功能：
1. 员工提交物资申请
2. 仓库管理员审批申请
3. 快速入库/出库操作
4. 库存查询
5. 消息通知
```

**3. 提交并等待审核**
- 审核时间通常为 1-7 个工作日
- 可在"版本管理"中查看审核状态
- 审核失败会收到拒绝原因

### 步骤 3：发布上线

**审核通过后：**
1. 进入"版本管理"
2. 点击"发布"按钮
3. 确认发布

**发布后：**
- 用户可在微信搜索小程序名称找到
- 可生成小程序码分发给用户
- 建议在企业内部公告推广

## 版本更新

### 日常更新流程

1. **修改代码**
   - 在开发环境完成功能开发
   - 充分测试新功能

2. **更新版本号**
   - 修改 `manifest.json` 中的 versionName
   - 遵循语义化版本规范（如：1.0.0 → 1.0.1）

3. **构建上传**
   - 执行构建命令
   - 使用开发者工具上传新版本
   - 填写更新日志

4. **提交审核**
   - 重复上述审核流程
   - 说明本次更新内容

5. **发布新版本**
   - 审核通过后发布
   - 用户打开小程序会自动更新

### 紧急修复流程

如遇紧急 Bug：

1. **快速修复**
   - 在本地紧急修复问题
   - 快速测试验证

2. **加急审核**
   - 提交审核时勾选"加急审核"
   - 说明紧急原因
   - 通常 2-24 小时内完成

3. **立即发布**
   - 审核通过立即发布
   - 通知用户重启小程序

## 运维监控

### 1. 数据统计

在微信公众平台查看：
- **数据分析**：访问量、用户数、使用时长
- **性能分析**：启动耗时、接口耗时
- **告警通知**：异常情况实时通知

### 2. 日志查看

**实时日志：**
1. 进入"开发" → "运维中心" → "实时日志"
2. 查看用户操作日志和错误日志
3. 用于排查线上问题

**远程调试：**
1. 打开"实时日志"
2. 点击"远程调试"
3. 可在电脑端调试真机上的问题

### 3. 用户反馈

**客服消息：**
1. 配置客服功能
2. 用户可直接在小程序内反馈
3. 及时响应用户问题

## 常见问题

### 1. 域名未配置

**错误提示：**
```
不在以下 request 合法域名列表中
```

**解决方案：**
- 在微信公众平台配置服务器域名
- 开发时可在开发者工具勾选"不校验合法域名"（仅开发环境）

### 2. 接口请求失败

**检查项：**
- 后端服务是否正常运行
- API 地址配置是否正确
- 服务器域名是否已配置
- SSL 证书是否有效

### 3. 图片不显示

**可能原因：**
- 图片路径错误
- 图片文件不存在
- 图片格式不支持
- 网络图片域名未配置

### 4. TabBar 不显示

**检查项：**
- pages.json 配置是否正确
- 图标文件是否存在
- 图标路径是否正确
- 图标尺寸是否符合要求

### 5. 登录失败

**可能原因：**
- AppID 配置错误
- 后端登录接口异常
- 未授权获取用户信息
- Token 处理有误

## 性能优化建议

### 1. 包大小优化

- 删除无用的文件和代码
- 压缩图片资源
- 使用分包加载（如超过 2MB）
- CDN 托管大文件

### 2. 加载速度优化

- 首屏数据预加载
- 图片懒加载
- 骨架屏优化
- 合理使用缓存

### 3. 性能监控

- 监控启动耗时
- 监控接口响应时间
- 监控页面渲染时间
- 及时优化性能瓶颈

## 安全注意事项

### 1. 数据安全

- 所有请求使用 HTTPS
- 敏感信息加密传输
- Token 有效期控制
- 定期更新密钥

### 2. 权限控制

- 前端角色校验
- 后端接口权限验证
- 数据隔离（部门级）
- 操作日志记录

### 3. 代码安全

- 不在代码中硬编码密钥
- 使用环境变量管理配置
- 定期检查依赖安全性
- 代码混淆和压缩

## 备份与回滚

### 代码备份

- 使用 Git 版本管理
- 打 Tag 标记重要版本
- 保留历史版本代码

### 版本回滚

如发现严重问题：
1. 登录微信公众平台
2. 进入"版本管理"
3. 选择上一个稳定版本
4. 点击"回退版本"

**注意：** 每月只能回退 1 次

## 技术支持

遇到问题可通过以下渠道获取帮助：

**官方文档：**
- [微信小程序开发文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [uni-app 官方文档](https://uniapp.dcloud.io/)

**社区支持：**
- 微信开放社区
- uni-app 论坛
- SegmentFault
- Stack Overflow

**内部支持：**
- 技术支持邮箱：tech-support@example.com
- 项目负责人：[联系方式]

---

**祝部署顺利！** 🎉
