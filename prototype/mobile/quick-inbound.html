<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿«é€Ÿå…¥åº“ - ä»“åº“ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../assets/css/mobile-common.css">
</head>
<body>
    <div class="mobile-container">
        <div class="navbar">
            <div class="navbar-back" onclick="goBack()">â†</div>
            <div class="navbar-title">å¿«é€Ÿå…¥åº“</div>
        </div>

        <div class="page">
            <form id="inboundForm">
                <!-- ä»“åº“é€‰æ‹© -->
                <div style="background: white; border-radius: 8px; margin-bottom: 12px;">
                    <div class="form-cell">
                        <div class="form-label required">é€‰æ‹©ä»“åº“</div>
                        <select class="form-select" id="warehouseId" required style="border: none; text-align: right; color: #323233;">
                            <option value="">è¯·é€‰æ‹©ä»“åº“</option>
                        </select>
                        <div class="form-arrow">â€º</div>
                    </div>
                </div>

                <!-- ç‰©èµ„åˆ—è¡¨ -->
                <div style="background: white; border-radius: 8px; margin-bottom: 12px;">
                    <div style="padding: 16px; border-bottom: 1px solid #ebedf0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: 500;">å…¥åº“ç‰©èµ„</div>
                        <button type="button" style="background: #1989fa; color: white; border: none; padding: 4px 12px; border-radius: 4px; font-size: 13px;" onclick="addMaterial()">+ æ·»åŠ </button>
                    </div>
                    <div id="materialList"></div>
                </div>

                <!-- å¤‡æ³¨ -->
                <div style="background: white; border-radius: 8px; margin-bottom: 12px;">
                    <div class="form-cell" style="align-items: start;">
                        <div class="form-label" style="margin-top: 8px;">å¤‡æ³¨</div>
                        <textarea class="form-textarea" id="remark" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰" style="border: none;"></textarea>
                    </div>
                </div>

                <!-- åˆè®¡ -->
                <div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 15px; font-weight: 500;">åˆè®¡é‡‘é¢</div>
                        <div id="totalAmount" style="font-size: 24px; font-weight: 600; color: #ee0a24;">Â¥0.00</div>
                    </div>
                </div>

                <!-- æç¤º -->
                <div style="background: #fff7e6; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <div style="font-size: 13px; color: #ff976a; line-height: 1.6;">
                        ğŸ’¡ å¿«é€Ÿå…¥åº“é€‚ç”¨äºæ—¥å¸¸è¡¥è´§åœºæ™¯ï¼Œç‰©èµ„å…¥åº“åç«‹å³æ›´æ–°åº“å­˜
                    </div>
                </div>
            </form>
        </div>

        <!-- åº•éƒ¨æŒ‰é’® -->
        <div class="btn-group">
            <button class="btn btn-default" onclick="goBack()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitInbound()">ç¡®è®¤å…¥åº“</button>
        </div>
    </div>

    <script src="../assets/js/mock-data.js"></script>
    <script src="../assets/js/common.js"></script>
    <script>
        let materials = [];

        // åˆå§‹åŒ–ä»“åº“ä¸‹æ‹‰æ¡†
        function initWarehouse() {
            const select = document.getElementById('warehouseId');
            const user = { deptId: 1 }; // å‡è®¾å½“å‰ç”¨æˆ·çš„éƒ¨é—¨ID
            const warehouses = mockData.warehouses.filter(w => w.deptId === user.deptId);

            warehouses.forEach(w => {
                const option = document.createElement('option');
                option.value = w.id;
                option.textContent = w.name;
                select.appendChild(option);
            });

            if (warehouses.length > 0) {
                select.value = warehouses[0].id;
            }
        }

        // æ·»åŠ ç‰©èµ„
        function addMaterial() {
            const materialId = generateId();
            materials.push({
                id: materialId,
                materialId: null,
                quantity: 1,
                price: 0
            });
            renderMaterialList();
        }

        // æ¸²æŸ“ç‰©èµ„åˆ—è¡¨
        function renderMaterialList() {
            const container = document.getElementById('materialList');
            let html = '';

            materials.forEach((item, index) => {
                const material = item.materialId ? mockData.materials.find(m => m.id === item.materialId) : null;

                html += `
                    <div style="padding: 16px; border-bottom: 1px solid #ebedf0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-weight: 500; color: #323233;">ç‰©èµ„ ${index + 1}</div>
                            <button type="button" style="background: none; border: none; color: #ee0a24; font-size: 14px;" onclick="removeMaterial('${item.id}')">åˆ é™¤</button>
                        </div>

                        <div class="form-cell" style="padding: 8px 0; border-bottom: 1px solid #f7f8fa;">
                            <div class="form-label required">ç‰©èµ„åç§°</div>
                            <select class="form-select" onchange="selectMaterial('${item.id}', this.value)" required style="border: none; text-align: right; color: #323233;">
                                <option value="">è¯·é€‰æ‹©ç‰©èµ„</option>
                                ${mockData.materials.map(m => `<option value="${m.id}" ${item.materialId === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                            </select>
                            <div class="form-arrow">â€º</div>
                        </div>

                        ${material ? `
                            <div class="form-cell" style="padding: 8px 0; border-bottom: 1px solid #f7f8fa;">
                                <div class="form-label">è§„æ ¼å‹å·</div>
                                <div style="color: #969799;">${material.spec}</div>
                            </div>

                            <div class="form-cell" style="padding: 8px 0; border-bottom: 1px solid #f7f8fa;">
                                <div class="form-label">å•ä½</div>
                                <div style="color: #969799;">${material.unit}</div>
                            </div>

                            <div class="form-cell" style="padding: 8px 0; border-bottom: 1px solid #f7f8fa;">
                                <div class="form-label required">æ•°é‡</div>
                                <input type="number" class="form-input" value="${item.quantity}" min="1" onchange="updateQuantity('${item.id}', this.value)" required style="border: none; text-align: right; color: #323233; width: 100px;">
                            </div>

                            <div class="form-cell" style="padding: 8px 0;">
                                <div class="form-label required">å•ä»·</div>
                                <input type="number" class="form-input" value="${item.price}" step="0.01" min="0" onchange="updatePrice('${item.id}', this.value)" required style="border: none; text-align: right; color: #323233; width: 120px;">
                            </div>

                            <div style="margin-top: 8px; padding: 8px; background: #f7f8fa; border-radius: 4px; display: flex; justify-content: space-between;">
                                <span style="color: #646566;">å°è®¡</span>
                                <span style="color: #ee0a24; font-weight: 500;">${formatMoney(item.quantity * item.price)}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            if (materials.length === 0) {
                html = '<div style="padding: 40px; text-align: center; color: #969799;">è¯·æ·»åŠ å…¥åº“ç‰©èµ„</div>';
            }

            container.innerHTML = html;
            calculateTotal();
        }

        // é€‰æ‹©ç‰©èµ„
        function selectMaterial(itemId, materialId) {
            const item = materials.find(m => m.id === itemId);
            if (!item) return;

            item.materialId = parseInt(materialId) || null;

            if (item.materialId) {
                const material = mockData.materials.find(m => m.id === item.materialId);
                if (material) {
                    item.price = material.price;
                }
            }

            renderMaterialList();
        }

        // æ›´æ–°æ•°é‡
        function updateQuantity(itemId, quantity) {
            const item = materials.find(m => m.id === itemId);
            if (item) {
                item.quantity = parseInt(quantity) || 1;
                renderMaterialList();
            }
        }

        // æ›´æ–°å•ä»·
        function updatePrice(itemId, price) {
            const item = materials.find(m => m.id === itemId);
            if (item) {
                item.price = parseFloat(price) || 0;
                renderMaterialList();
            }
        }

        // åˆ é™¤ç‰©èµ„
        function removeMaterial(itemId) {
            const index = materials.findIndex(m => m.id === itemId);
            if (index > -1) {
                materials.splice(index, 1);
                renderMaterialList();
            }
        }

        // è®¡ç®—æ€»é‡‘é¢
        function calculateTotal() {
            let total = 0;
            materials.forEach(item => {
                if (item.materialId) {
                    total += item.quantity * item.price;
                }
            });
            document.getElementById('totalAmount').textContent = formatMoney(total);
        }

        // æäº¤å…¥åº“
        function submitInbound() {
            const warehouseId = document.getElementById('warehouseId').value;

            if (!warehouseId) {
                Toast.show('è¯·é€‰æ‹©ä»“åº“');
                return;
            }

            if (materials.length === 0) {
                Toast.show('è¯·è‡³å°‘æ·»åŠ ä¸€æ¡å…¥åº“ç‰©èµ„');
                return;
            }

            // éªŒè¯æ‰€æœ‰ç‰©èµ„æ˜¯å¦å·²é€‰æ‹©
            const hasEmpty = materials.some(item => !item.materialId);
            if (hasEmpty) {
                Toast.show('è¯·å®Œæ•´å¡«å†™æ‰€æœ‰ç‰©èµ„ä¿¡æ¯');
                return;
            }

            Loading.show('æ­£åœ¨æäº¤...');
            setTimeout(() => {
                Loading.hide();
                Toast.show('å…¥åº“æˆåŠŸ');
                setTimeout(() => {
                    location.href = 'warehouse-home.html';
                }, 1500);
            }, 1000);
        }

        function init() {
            initWarehouse();
            addMaterial(); // é»˜è®¤æ·»åŠ ä¸€è¡Œ
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
