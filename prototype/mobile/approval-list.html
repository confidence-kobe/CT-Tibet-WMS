<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¡æ‰¹ç®¡ç† - ä»“åº“ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../assets/css/mobile-common.css">
</head>
<body>
    <div class="mobile-container">
        <div class="navbar">
            <div class="navbar-back" onclick="goBack()">â†</div>
            <div class="navbar-title">å®¡æ‰¹ç®¡ç†</div>
        </div>

        <div class="page">
            <div class="filter-bar">
                <div class="filter-tab active" onclick="filterByStatus(0)">å¾…å®¡æ‰¹</div>
                <div class="filter-tab" onclick="filterByStatus(1)">å·²é€šè¿‡</div>
                <div class="filter-tab" onclick="filterByStatus(2)">å·²æ‹’ç»</div>
            </div>

            <div class="list" id="approvalList"></div>
        </div>

        <div class="tabbar">
            <div class="tabbar-item" onclick="location.href='warehouse-home.html'"><div class="tabbar-icon">ğŸ </div><div class="tabbar-text">é¦–é¡µ</div></div>
            <div class="tabbar-item active"><div class="tabbar-icon">âœ“</div><div class="tabbar-text">å®¡æ‰¹</div></div>
            <div class="tabbar-item" onclick="location.href='inventory-list.html'"><div class="tabbar-icon">ğŸ“Š</div><div class="tabbar-text">åº“å­˜</div></div>
            <div class="tabbar-item" onclick="Toast.show('æˆ‘çš„')"><div class="tabbar-icon">ğŸ‘¤</div><div class="tabbar-text">æˆ‘çš„</div></div>
        </div>
    </div>

    <script src="../assets/js/mock-data.js"></script>
    <script src="../assets/js/common.js"></script>
    <script>
        function renderList(status = 0) {
            const list = document.getElementById('approvalList');
            const data = mockData.applyList.filter(a => a.status === status);

            let html = '';
            data.forEach(item => {
                html += `
                    <div class="list-item" onclick="${status === 0 ? `showApprovalDetail('${item.code}')` : 'void(0)'}">
                        <div class="list-header">
                            <div class="list-title">${item.code}</div>
                            ${getStatusTag(item.status, item.statusText, 'apply')}
                        </div>
                        <div class="list-info">
                            <div style="margin-bottom: 4px;"><strong>${item.applyUser}</strong> - ${item.applyDept}</div>
                            <div style="color: #969799;">${item.purpose}</div>
                        </div>
                        <div class="list-meta">
                            <span>${item.itemCount}ç§ç‰©èµ„ | ${formatMoney(item.totalAmount)}</span>
                            <span>${formatDateTime(item.applyTime)}</span>
                        </div>
                        ${status === 0 ? `
                            <div style="margin-top: 12px; display: flex; gap: 12px;">
                                <button class="btn btn-danger" style="flex: 1; height: 36px;" onclick="event.stopPropagation(); handleReject('${item.code}')">æ‹’ç»</button>
                                <button class="btn btn-success" style="flex: 1; height: 36px;" onclick="event.stopPropagation(); handleApprove('${item.code}')">é€šè¿‡</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            if (data.length === 0) {
                html = '<div class="empty-state"><div class="empty-icon">âœ“</div><div class="empty-text">æš‚æ— å¾…å®¡æ‰¹ç”³è¯·</div></div>';
            }

            list.innerHTML = html;
        }

        function filterByStatus(status) {
            renderList(status);
            document.querySelectorAll('.filter-tab').forEach((tab, i) => {
                tab.className = 'filter-tab' + ([0, 1, 2][i] === status ? ' active' : '');
            });
        }

        function showApprovalDetail(code) {
            const item = mockData.applyList.find(i => i.code === code);
            if (!item) return;

            let detailHtml = '';
            item.details.forEach(d => {
                const stockOk = d.quantity <= d.stockQuantity;
                detailHtml += `
                    <div style="padding: 12px; background: #f7f8fa; border-radius: 4px; margin-bottom: 8px;">
                        <div style="font-weight: 500; margin-bottom: 4px;">${d.materialName}</div>
                        <div style="font-size: 13px; color: #646566;">è§„æ ¼ï¼š${d.spec}</div>
                        <div style="font-size: 13px; color: #646566;">ç”³è¯·æ•°é‡ï¼š${d.quantity} | åº“å­˜ï¼š${d.stockQuantity} <span style="color: ${stockOk ? '#07c160' : '#ee0a24'}">${stockOk ? 'âœ“' : 'âš ï¸åº“å­˜ä¸è¶³'}</span></div>
                        <div style="font-size: 13px; color: #ee0a24; margin-top: 4px;">å°è®¡ï¼š${formatMoney(d.amount)}</div>
                    </div>
                `;
            });

            const content = `
                <div style="font-size: 14px;">
                    <div style="margin-bottom: 16px;">
                        <div style="margin-bottom: 8px;"><strong>ç”³è¯·äººï¼š</strong>${item.applyUser} - ${item.applyDept}</div>
                        <div style="margin-bottom: 8px;"><strong>ç”³è¯·ç”¨é€”ï¼š</strong>${item.purpose}</div>
                        <div style="margin-bottom: 8px;"><strong>ç”³è¯·æ—¶é—´ï¼š</strong>${formatDateTime(item.applyTime)}</div>
                        <div><strong>ç”³è¯·é‡‘é¢ï¼š</strong><span style="color: #ee0a24; font-size: 18px; font-weight: 600;">${formatMoney(item.totalAmount)}</span></div>
                    </div>
                    <div style="border-top: 1px solid #ebedf0; padding-top: 12px;">
                        <strong>ç”³è¯·æ˜ç»†ï¼š</strong>
                        <div style="margin-top: 8px;">${detailHtml}</div>
                    </div>
                </div>
            `;

            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';
            overlay.innerHTML = `
                <div class="popup">
                    <div class="popup-header">
                        <div class="popup-title">ç”³è¯·è¯¦æƒ…</div>
                        <div class="popup-close">Ã—</div>
                    </div>
                    <div class="popup-body">${content}</div>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.querySelector('.popup-close').onclick = () => overlay.remove();
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
        }

        function handleApprove(code) {
            Loading.show('æ­£åœ¨å¤„ç†...');
            setTimeout(() => {
                Loading.hide();
                Toast.show('å®¡æ‰¹é€šè¿‡');
                const item = mockData.applyList.find(i => i.code === code);
                if (item) {
                    item.status = 1;
                    item.statusText = 'å·²é€šè¿‡';
                }
                renderList(0);
            }, 1000);
        }

        function handleReject(code) {
            Toast.show('æ‹’ç»ç”³è¯·ï¼ˆå®é™…éœ€è¦å¡«å†™æ‹’ç»ç†ç”±ï¼‰');
        }

        document.addEventListener('DOMContentLoaded', () => renderList(0));
    </script>
</body>
</html>
