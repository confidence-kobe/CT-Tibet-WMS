<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç”³è¯· - è¥¿è—ç”µä¿¡ä»“åº“ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../assets/css/pc-common.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><div class="sidebar-logo">ğŸ“¦</div><div class="sidebar-title">ä»“åº“ç®¡ç†ç³»ç»Ÿ</div></div>
            <nav class="sidebar-menu">
                <div class="menu-item" onclick="location.href='dashboard.html'"><span class="menu-item-icon">ğŸ </span><span>å·¥ä½œå°</span></div>
                <div class="menu-item active"><span class="menu-item-icon">ğŸ“</span><span>æˆ‘çš„ç”³è¯·</span></div>
                <div class="menu-item" onclick="location.href='inventory-list.html'"><span class="menu-item-icon">ğŸ“Š</span><span>åº“å­˜æŸ¥è¯¢</span></div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <div class="breadcrumb"><span class="breadcrumb-item active">æˆ‘çš„ç”³è¯·</span></div>
                </div>
                <div class="header-right">
                    <div class="notification-btn"><span>ğŸ””</span><span class="notification-badge">1</span></div>
                    <div class="user-info"><div class="user-avatar">æ</div><span>ææ˜</span></div>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">æˆ‘çš„ç”³è¯·</div>
                        <button class="btn btn-primary" onclick="location.href='apply-create.html'">+ æ–°å»ºç”³è¯·</button>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="filterByStatus(null)">å…¨éƒ¨</button>
                        <button class="btn btn-default" onclick="filterByStatus(0)">å¾…å®¡æ‰¹</button>
                        <button class="btn btn-default" onclick="filterByStatus(1)">å·²é€šè¿‡</button>
                        <button class="btn btn-default" onclick="filterByStatus(2)">å·²æ‹’ç»</button>
                        <button class="btn btn-default" onclick="filterByStatus(3)">å·²å®Œæˆ</button>
                    </div>

                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>ç”³è¯·å•å·</th>
                                <th>ç”³è¯·ç”¨é€”</th>
                                <th>ç‰©èµ„ç§ç±»</th>
                                <th>ç”³è¯·é‡‘é¢</th>
                                <th>çŠ¶æ€</th>
                                <th>ç”³è¯·æ—¶é—´</th>
                                <th>å®¡æ‰¹äºº</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="../assets/js/mock-data.js"></script>
    <script src="../assets/js/common.js"></script>
    <script>
        const currentUserId = 3; // ææ˜çš„ç”¨æˆ·ID

        function renderTable(status = null) {
            const tbody = document.querySelector('#dataTable tbody');
            let data = mockData.applyList.filter(a => a.applyUserId === currentUserId);

            if (status !== null) {
                data = data.filter(a => a.status === status);
            }

            let html = '';
            data.forEach(item => {
                html += `
                    <tr>
                        <td><a href="#" class="text-primary" onclick="showDetail('${item.code}'); return false;">${item.code}</a></td>
                        <td>${item.purpose}</td>
                        <td>${item.itemCount}</td>
                        <td class="text-danger">${formatMoney(item.totalAmount)}</td>
                        <td>${getStatusTag(item.status, item.statusText, 'apply')}</td>
                        <td>${formatDateTime(item.applyTime)}</td>
                        <td>${item.approver || '-'}</td>
                        <td>
                            ${item.status === 0 ? `<button class="btn btn-text text-danger" onclick="handleCancel('${item.code}')">æ’¤é”€</button>` : ''}
                            ${item.status === 2 ? `<button class="btn btn-text text-primary" onclick="location.href='apply-create.html?copy=${item.code}'">é‡æ–°ç”³è¯·</button>` : ''}
                            <button class="btn btn-text" onclick="showDetail('${item.code}')">æŸ¥çœ‹è¯¦æƒ…</button>
                        </td>
                    </tr>
                `;
            });

            if (data.length === 0) {
                html = '<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">æš‚æ— ç”³è¯·è®°å½•</div></div></td></tr>';
            }

            tbody.innerHTML = html;
        }

        function filterByStatus(status) {
            renderTable(status);
            document.querySelectorAll('.content-wrapper .btn').forEach((btn, i) => {
                if (i > 0 && i < 6) {
                    btn.className = 'btn ' + ([null, 0, 1, 2, 3][i - 1] === status ? 'btn-primary' : 'btn-default');
                }
            });
        }

        function showDetail(code) {
            const item = mockData.applyList.find(i => i.code === code);
            if (!item) return;

            let detailsHtml = '<table style="width: 100%; font-size: 14px; margin-top: 16px;"><thead><tr><th>ç‰©èµ„åç§°</th><th>è§„æ ¼å‹å·</th><th>ç”³è¯·æ•°é‡</th><th>å½“å‰åº“å­˜</th><th>å•ä»·</th><th>é‡‘é¢</th></tr></thead><tbody>';
            item.details.forEach(d => {
                const stockStatus = d.quantity > d.stockQuantity ? '<span class="text-danger">(åº“å­˜ä¸è¶³)</span>' : '<span class="text-success">(åº“å­˜å……è¶³)</span>';
                detailsHtml += `
                    <tr>
                        <td>${d.materialName}</td>
                        <td>${d.spec}</td>
                        <td>${d.quantity}</td>
                        <td>${d.stockQuantity} ${stockStatus}</td>
                        <td>${formatMoney(d.price)}</td>
                        <td class="text-danger">${formatMoney(d.amount)}</td>
                    </tr>
                `;
            });
            detailsHtml += '</tbody></table>';

            const statusMessages = {
                0: '<div style="padding: 12px; background: #fff7e6; border-radius: 4px; margin-top: 16px;">â³ ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…å®¡æ‰¹...</div>',
                1: `<div style="padding: 12px; background: #f6ffed; border-radius: 4px; margin-top: 16px;">âœ“ å®¡æ‰¹å·²é€šè¿‡ï¼Œè¯·åŠæ—¶é¢†å–ç‰©èµ„<br><strong>å®¡æ‰¹æ„è§ï¼š</strong>${item.approveRemark}</div>`,
                2: `<div style="padding: 12px; background: #fff1f0; border-radius: 4px; margin-top: 16px;">âœ— ç”³è¯·å·²è¢«æ‹’ç»<br><strong>æ‹’ç»ç†ç”±ï¼š</strong>${item.approveRemark}</div>`,
                3: '<div style="padding: 12px; background: #e6f7ff; border-radius: 4px; margin-top: 16px;">âœ“ ç‰©èµ„å·²é¢†å–ï¼Œç”³è¯·å·²å®Œæˆ</div>'
            };

            const content = `
                <div style="font-size: 14px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                        <div><strong>ç”³è¯·å•å·ï¼š</strong>${item.code}</div>
                        <div><strong>çŠ¶æ€ï¼š</strong>${getStatusTag(item.status, item.statusText, 'apply')}</div>
                        <div><strong>ç”³è¯·æ—¶é—´ï¼š</strong>${formatDateTime(item.applyTime)}</div>
                        <div><strong>ç”³è¯·é‡‘é¢ï¼š</strong><span class="text-danger">${formatMoney(item.totalAmount)}</span></div>
                        <div style="grid-column: 1 / -1;"><strong>ç”³è¯·ç”¨é€”ï¼š</strong>${item.purpose}</div>
                        ${item.approver ? `
                            <div><strong>å®¡æ‰¹äººï¼š</strong>${item.approver}</div>
                            <div><strong>å®¡æ‰¹æ—¶é—´ï¼š</strong>${formatDateTime(item.approveTime)}</div>
                        ` : ''}
                    </div>
                    <div style="border-top: 1px solid #f0f0f0; padding-top: 16px;">
                        <strong>ç”³è¯·æ˜ç»†ï¼š</strong>
                        ${detailsHtml}
                    </div>
                    ${statusMessages[item.status] || ''}
                </div>
            `;

            showDetailModal('ç”³è¯·è¯¦æƒ…', content);
        }

        function handleCancel(code) {
            confirm(
                'æ’¤é”€ç”³è¯·',
                'ç¡®å®šè¦æ’¤é”€è¯¥ç”³è¯·å—ï¼Ÿæ’¤é”€åæ— æ³•æ¢å¤ã€‚',
                () => {
                    Loading.show('æ­£åœ¨å¤„ç†...');
                    setTimeout(() => {
                        Loading.hide();
                        Message.success('ç”³è¯·å·²æ’¤é”€');
                        const item = mockData.applyList.find(i => i.code === code);
                        if (item) {
                            item.status = 4;
                            item.statusText = 'å·²å–æ¶ˆ';
                        }
                        renderTable();
                    }, 1000);
                }
            );
        }

        function init() {
            renderTable();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
