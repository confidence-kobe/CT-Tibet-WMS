<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¡æ‰¹ç®¡ç† - è¥¿è—ç”µä¿¡ä»“åº“ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../assets/css/pc-common.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">ğŸ“¦</div>
                <div class="sidebar-title">ä»“åº“ç®¡ç†ç³»ç»Ÿ</div>
            </div>
            <nav class="sidebar-menu">
                <div class="menu-item" onclick="location.href='dashboard.html'"><span class="menu-item-icon">ğŸ </span><span>å·¥ä½œå°</span></div>
                <div class="menu-item" onclick="location.href='inbound-list.html'"><span class="menu-item-icon">ğŸ“¥</span><span>å…¥åº“ç®¡ç†</span></div>
                <div class="menu-item" onclick="location.href='outbound-list.html'"><span class="menu-item-icon">ğŸ“¤</span><span>å‡ºåº“ç®¡ç†</span></div>
                <div class="menu-item active"><span class="menu-item-icon">âœ“</span><span>å®¡æ‰¹ç®¡ç†</span></div>
                <div class="menu-item" onclick="location.href='inventory-list.html'"><span class="menu-item-icon">ğŸ“Š</span><span>åº“å­˜æŸ¥è¯¢</span></div>
                <div class="menu-item" onclick="location.href='stats.html'"><span class="menu-item-icon">ğŸ“ˆ</span><span>ç»Ÿè®¡æŠ¥è¡¨</span></div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <div class="breadcrumb"><span class="breadcrumb-item active">å®¡æ‰¹ç®¡ç†</span></div>
                </div>
                <div class="header-right">
                    <div class="notification-btn"><span>ğŸ””</span><span class="notification-badge">2</span></div>
                    <div class="user-info"><div class="user-avatar">å¼ </div><span>å¼ ä¸‰</span></div>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ç”³è¯·å®¡æ‰¹</div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="filterByStatus(0)">å¾…å®¡æ‰¹</button>
                        <button class="btn btn-default" onclick="filterByStatus(1)">å·²é€šè¿‡</button>
                        <button class="btn btn-default" onclick="filterByStatus(2)">å·²æ‹’ç»</button>
                        <button class="btn btn-default" onclick="filterByStatus(null)">å…¨éƒ¨</button>
                    </div>

                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>ç”³è¯·å•å·</th>
                                <th>ç”³è¯·äºº</th>
                                <th>éƒ¨é—¨</th>
                                <th>ç”³è¯·ç”¨é€”</th>
                                <th>ç‰©èµ„ç§ç±»</th>
                                <th>ç”³è¯·é‡‘é¢</th>
                                <th>çŠ¶æ€</th>
                                <th>ç”³è¯·æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="../assets/js/mock-data.js"></script>
    <script src="../assets/js/common.js"></script>
    <script>
        let filterStatusValue = 0; // é»˜è®¤æ˜¾ç¤ºå¾…å®¡æ‰¹

        function renderTable(data) {
            const tbody = document.querySelector('#dataTable tbody');
            let html = '';

            data.forEach(item => {
                html += `
                    <tr>
                        <td><a href="#" class="text-primary" onclick="showApprovalDetail('${item.code}'); return false;">${item.code}</a></td>
                        <td>${item.applyUser}</td>
                        <td>${item.applyDept}</td>
                        <td>${item.purpose}</td>
                        <td>${item.itemCount}</td>
                        <td class="text-danger">${formatMoney(item.totalAmount)}</td>
                        <td>${getStatusTag(item.status, item.statusText, 'apply')}</td>
                        <td>${formatDateTime(item.applyTime)}</td>
                        <td>
                            ${item.status === 0 ? `
                                <button class="btn btn-text text-success" onclick="handleApprove('${item.code}')">é€šè¿‡</button>
                                <button class="btn btn-text text-danger" onclick="handleReject('${item.code}')">æ‹’ç»</button>
                            ` : `
                                <button class="btn btn-text" onclick="showApprovalDetail('${item.code}')">æŸ¥çœ‹è¯¦æƒ…</button>
                            `}
                        </td>
                    </tr>
                `;
            });

            if (data.length === 0) {
                html = '<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">âœ“</div><div class="empty-text">æš‚æ— å¾…å®¡æ‰¹ç”³è¯·</div></div></td></tr>';
            }

            tbody.innerHTML = html;
        }

        function filterByStatus(status) {
            filterStatusValue = status;
            const data = status === null
                ? mockData.applyList
                : mockData.applyList.filter(i => i.status === status);
            renderTable(data);

            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.content-wrapper .btn').forEach((btn, i) => {
                if (i < 4) {
                    btn.className = 'btn ' + ([0, 1, 2, null][i] === status ? 'btn-primary' : 'btn-default');
                }
            });
        }

        function showApprovalDetail(code) {
            const item = mockData.applyList.find(i => i.code === code);
            if (!item) return;

            let detailsHtml = '<table style="width: 100%; font-size: 14px; margin-top: 16px;"><thead><tr><th>ç‰©èµ„åç§°</th><th>è§„æ ¼å‹å·</th><th>ç”³è¯·æ•°é‡</th><th>å½“å‰åº“å­˜</th><th>å•ä»·</th><th>é‡‘é¢</th></tr></thead><tbody>';
            item.details.forEach(d => {
                const stockStatus = d.quantity > d.stockQuantity ? '<span class="text-danger">(åº“å­˜ä¸è¶³)</span>' : '<span class="text-success">(åº“å­˜å……è¶³)</span>';
                detailsHtml += `
                    <tr>
                        <td>${d.materialName}</td>
                        <td>${d.spec}</td>
                        <td>${d.quantity}</td>
                        <td>${d.stockQuantity} ${stockStatus}</td>
                        <td>${formatMoney(d.price)}</td>
                        <td class="text-danger">${formatMoney(d.amount)}</td>
                    </tr>
                `;
            });
            detailsHtml += '</tbody></table>';

            const content = `
                <div style="font-size: 14px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                        <div><strong>ç”³è¯·å•å·ï¼š</strong>${item.code}</div>
                        <div><strong>ç”³è¯·äººï¼š</strong>${item.applyUser}</div>
                        <div><strong>æ‰€å±éƒ¨é—¨ï¼š</strong>${item.applyDept}</div>
                        <div><strong>ç”³è¯·æ—¶é—´ï¼š</strong>${formatDateTime(item.applyTime)}</div>
                        <div><strong>ç”³è¯·é‡‘é¢ï¼š</strong><span class="text-danger">${formatMoney(item.totalAmount)}</span></div>
                        <div><strong>çŠ¶æ€ï¼š</strong>${getStatusTag(item.status, item.statusText, 'apply')}</div>
                        <div style="grid-column: 1 / -1;"><strong>ç”³è¯·ç”¨é€”ï¼š</strong>${item.purpose}</div>
                        ${item.approver ? `
                            <div><strong>å®¡æ‰¹äººï¼š</strong>${item.approver}</div>
                            <div><strong>å®¡æ‰¹æ—¶é—´ï¼š</strong>${formatDateTime(item.approveTime)}</div>
                            <div style="grid-column: 1 / -1;"><strong>å®¡æ‰¹æ„è§ï¼š</strong>${item.approveRemark || '-'}</div>
                        ` : ''}
                    </div>
                    <div style="border-top: 1px solid #f0f0f0; padding-top: 16px;">
                        <strong>ç”³è¯·æ˜ç»†ï¼š</strong>
                        ${detailsHtml}
                    </div>
                </div>
            `;

            showDetailModal('ç”³è¯·è¯¦æƒ…', content);
        }

        function handleApprove(code) {
            const item = mockData.applyList.find(i => i.code === code);

            // æ£€æŸ¥åº“å­˜
            let stockSufficient = true;
            item.details.forEach(d => {
                if (d.quantity > d.stockQuantity) {
                    stockSufficient = false;
                }
            });

            if (!stockSufficient) {
                confirm(
                    'åº“å­˜ä¸è¶³',
                    'å½“å‰ç”³è¯·çš„éƒ¨åˆ†ç‰©èµ„åº“å­˜ä¸è¶³ï¼Œæ˜¯å¦ä»è¦é€šè¿‡å®¡æ‰¹ï¼Ÿ',
                    () => proceedApprove(code)
                );
            } else {
                proceedApprove(code);
            }
        }

        function proceedApprove(code) {
            Loading.show('æ­£åœ¨å¤„ç†...');
            setTimeout(() => {
                Loading.hide();
                Message.success('å®¡æ‰¹é€šè¿‡ï¼Œå·²è‡ªåŠ¨åˆ›å»ºå‡ºåº“å•');

                const item = mockData.applyList.find(i => i.code === code);
                if (item) {
                    item.status = 1;
                    item.statusText = 'å·²é€šè¿‡';
                    item.approver = 'å¼ ä¸‰';
                    item.approveTime = new Date().toISOString().substring(0, 19).replace('T', ' ');
                    item.approveRemark = 'åŒæ„';
                }

                filterByStatus(filterStatusValue);
            }, 1000);
        }

        function handleReject(code) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <div class="modal-title">æ‹’ç»ç”³è¯·</div>
                        <span class="modal-close">Ã—</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label required">æ‹’ç»ç†ç”±</label>
                            <textarea class="form-textarea" id="rejectReason" placeholder="è¯·è¾“å…¥æ‹’ç»ç†ç”±" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" onclick="this.closest('.modal-overlay').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-danger" onclick="submitReject('${code}')">ç¡®è®¤æ‹’ç»</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            overlay.querySelector('.modal-close').onclick = () => overlay.remove();
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
        }

        function submitReject(code) {
            const reason = document.getElementById('rejectReason').value.trim();
            if (!reason) {
                Message.warning('è¯·è¾“å…¥æ‹’ç»ç†ç”±');
                return;
            }

            document.querySelector('.modal-overlay').remove();
            Loading.show('æ­£åœ¨å¤„ç†...');

            setTimeout(() => {
                Loading.hide();
                Message.success('å·²æ‹’ç»ç”³è¯·');

                const item = mockData.applyList.find(i => i.code === code);
                if (item) {
                    item.status = 2;
                    item.statusText = 'å·²æ‹’ç»';
                    item.approver = 'å¼ ä¸‰';
                    item.approveTime = new Date().toISOString().substring(0, 19).replace('T', ' ');
                    item.approveRemark = reason;
                }

                filterByStatus(filterStatusValue);
            }, 1000);
        }

        function init() {
            filterByStatus(0); // é»˜è®¤æ˜¾ç¤ºå¾…å®¡æ‰¹
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
