version: '3.9'

# Production-ready Docker Compose configuration for CT-Tibet-WMS
# Features:
# - Health checks for all services
# - Volume persistence with backup strategy
# - Resource limits and memory management
# - Security configurations (non-root users, password protection)
# - Logging with rotation
# - High availability setup ready

services:
  # MySQL 8.0 Database - with production optimizations
  mysql:
    image: mysql:8.0.35
    container_name: ct-wms-mysql-prod
    restart: always
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-ct_tibet_wms}
      MYSQL_USER: ${MYSQL_USER:-wms_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Asia/Shanghai
    volumes:
      # Database data persistence
      - mysql_data:/var/lib/mysql
      # Initialize database from SQL script
      - ./sql/init-database.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      # MySQL configuration for production
      - ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      # Logs
      - ./logs/mysql:/var/log/mysql
    networks:
      - wms-network
    healthcheck:
      test:
        - CMD
        - mysqladmin
        - ping
        - -h
        - localhost
        - -u${MYSQL_USER}
        - -p${MYSQL_PASSWORD}
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    # Production MySQL configuration
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --default-storage-engine=InnoDB
      --max_connections=1000
      --max_allowed_packet=256M
      --innodb_buffer_pool_size=1G
      --innodb_log_file_size=256M
      --slow_query_log=1
      --slow_query_log_file=/var/log/mysql/slow.log
      --long_query_time=2
      --log_error=/var/log/mysql/error.log
      --general_log=0
      --binlog_format=row
      --skip-host-cache
      --skip-name-resolve
      --skip-external-locking
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: 5
        labels: app=mysql

  # Redis Cache with persistence
  redis:
    image: redis:7.2-alpine
    container_name: ct-wms-redis-prod
    restart: always
    ports:
      - "${REDIS_PORT:-6379}:6379"
    environment:
      TZ: Asia/Shanghai
    volumes:
      # Redis data persistence (RDB snapshots)
      - redis_data:/data
      # Redis configuration
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
      # Logs
      - ./logs/redis:/logs
    networks:
      - wms-network
    healthcheck:
      test:
        - CMD
        - redis-cli
        - -a
        - ${REDIS_PASSWORD:-redis-password}
        - ping
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    sysctls:
      - net.core.somaxconn=512
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    # Redis optimization: AOF persistence, maxmemory policy, requirepass
    command: >
      redis-server
      /usr/local/etc/redis/redis.conf
      --requirepass ${REDIS_PASSWORD:-redis-password}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
      --logfile /logs/redis.log
    logging:
      driver: json-file
      options:
        max-size: 20m
        max-file: 5
        labels: app=redis

  # RabbitMQ Message Queue (production setup with management interface)
  rabbitmq:
    image: rabbitmq:3.12.11-management-alpine
    container_name: ct-wms-rabbitmq-prod
    restart: always
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-wms_admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-changeme}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/wms}
      TZ: Asia/Shanghai
      # Memory and resource limits
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-rabbit vm_memory_high_watermark 0.6 -rabbit vm_memory_high_watermark_paging_ratio 0.75"
    volumes:
      # RabbitMQ data persistence
      - rabbitmq_data:/var/lib/rabbitmq
      # RabbitMQ configuration
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      # Logs
      - ./logs/rabbitmq:/var/log/rabbitmq
    networks:
      - wms-network
    healthcheck:
      test:
        - CMD
        - rabbitmq-diagnostics
        - -q
        - ping
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: 20m
        max-file: 5
        labels: app=rabbitmq

  # Backend Spring Boot Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        JAVA_VERSION: "11"
    image: ct-wms-backend:${APP_VERSION:-1.0.0}
    container_name: ct-wms-backend-prod
    restart: always
    ports:
      - "${BACKEND_PORT:-48888}:48888"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      # Spring Profiles
      SPRING_PROFILES_ACTIVE: prod

      # Server Configuration
      SERVER_PORT: 48888
      SERVER_SHUTDOWN: graceful
      SPRING_LIFECYCLE_TIMEOUT_PER_SHUTDOWN_PHASE: 30s

      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:mysql://${MYSQL_HOST:-mysql}:3306/${MYSQL_DATABASE:-ct_tibet_wms}?useUnicode=true&characterEncoding=utf8mb4&serverTimezone=Asia/Shanghai&useSSL=false&allowPublicKeyRetrieval=true&cachePrepStmts=true&prepStmtCacheSize=250&prepStmtCacheSqlLimit=2048
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER:-wms_user}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: com.mysql.cj.jdbc.Driver

      # HikariCP Connection Pool
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 20
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 5
      SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: 30000
      SPRING_DATASOURCE_HIKARI_IDLE_TIMEOUT: 600000
      SPRING_DATASOURCE_HIKARI_MAX_LIFETIME: 1800000

      # Redis Configuration
      SPRING_REDIS_HOST: ${REDIS_HOST:-redis}
      SPRING_REDIS_PORT: 6379
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      SPRING_REDIS_DATABASE: 0
      SPRING_REDIS_TIMEOUT: 3000
      SPRING_REDIS_LETTUCE_POOL_MAX_ACTIVE: 8
      SPRING_REDIS_LETTUCE_POOL_MAX_IDLE: 8
      SPRING_REDIS_LETTUCE_POOL_MIN_IDLE: 0
      SPRING_REDIS_LETTUCE_POOL_MAX_WAIT: -1ms

      # RabbitMQ Configuration
      SPRING_RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER:-wms_admin}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      SPRING_RABBITMQ_VIRTUAL_HOST: ${RABBITMQ_VHOST:-/wms}
      SPRING_RABBITMQ_PUBLISHER_CONFIRM_TYPE: correlated
      SPRING_RABBITMQ_PUBLISHER_RETURNS: true
      SPRING_RABBITMQ_CONNECTION_TIMEOUT: 10000
      SPRING_RABBITMQ_LISTENER_SIMPLE_ACKNOWLEDGE_MODE: manual
      SPRING_RABBITMQ_LISTENER_SIMPLE_PREFETCH: 1

      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: 7200
      JWT_REFRESH_EXPIRATION: 604800

      # File Upload Configuration
      FILE_UPLOAD_PATH: /data/wms/uploads
      FILE_MAX_SIZE: 10485760

      # Timezone
      TZ: Asia/Shanghai

      # Java Options - Production optimizations
      JAVA_OPTS: >
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -XX:+UnlockDiagnosticVMOptions
        -XX:G1SummarizeRSetStatsPeriod=1
        -XX:+UseStringDeduplication
        -Xms512m
        -Xmx2g
        -XX:+AlwaysPreTouch
        -XX:+ParallelRefProcEnabled
        -XX:+DisableExplicitGC
        -XX:+HeapDumpOnOutOfMemoryError
        -XX:HeapDumpPath=/logs/heapdump.hprof
        -Dfile.encoding=UTF-8
        -Duser.timezone=Asia/Shanghai

      # Spring Boot Actuator
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,metrics
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: when-authorized

    volumes:
      # Application logs
      - ./logs/backend:/app/logs
      # File uploads
      - ./uploads:/data/wms/uploads

    networks:
      - wms-network

    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:48888/actuator/health
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2.5G
        reservations:
          cpus: '1.5'
          memory: 1.5G

    logging:
      driver: json-file
      options:
        max-size: 100m
        max-file: 10
        labels: app=backend

  # Frontend Nginx Service
  frontend:
    build:
      context: ./frontend-pc
      dockerfile: Dockerfile
    image: ct-wms-frontend:${APP_VERSION:-1.0.0}
    container_name: ct-wms-frontend-prod
    restart: always
    ports:
      - "${FRONTEND_PORT:-80}:80"
      - "${FRONTEND_HTTPS_PORT:-443}:443"
    depends_on:
      - backend
    volumes:
      # Nginx configurations
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/nginx-site.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/gzip.conf:/etc/nginx/conf.d/gzip.conf:ro
      # SSL certificates (if using HTTPS)
      - ./nginx/ssl:/etc/nginx/ssl:ro
      # Nginx cache
      - nginx_cache:/var/cache/nginx
      # Logs
      - ./logs/nginx:/var/log/nginx

    networks:
      - wms-network

    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --tries=1
        - --spider
        - http://localhost/health
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

    environment:
      TZ: Asia/Shanghai

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: 5
        labels: app=frontend

# Named volumes for persistent data
volumes:
  # MySQL persistent storage
  mysql_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/mysql

  # Redis persistent storage
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/redis

  # RabbitMQ persistent storage
  rabbitmq_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/rabbitmq

  # Nginx cache
  nginx_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/nginx/cache

# Custom bridge network for service communication
networks:
  wms-network:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1500
    ipam:
      config:
        - subnet: 172.28.0.0/16
