# Redis Production Configuration for CT-Tibet-WMS
# Reference: https://redis.io/docs/management/config/

# ============================================================================
# NETWORK SETTINGS
# ============================================================================
# Accept connections on specified port
port 6379
# Accept connections from all interfaces
bind 0.0.0.0
# TCP backlog
tcp-backlog 511
# TCP keepalive
tcp-keepalive 300
# Idle client timeout (0 = disable)
timeout 0

# ============================================================================
# GENERAL SETTINGS
# ============================================================================
# Daemonize (disable in Docker)
daemonize no
# Supervised (systemd, upstart)
supervised no
# PID file location
pidfile /var/run/redis.pid
# Logging level
loglevel notice
# Log file
logfile /logs/redis.log
# Log to syslog
syslog-enabled no

# ============================================================================
# SNAPSHOTTING (RDB) - Point-in-time persistence
# ============================================================================
# Save the database on disk - format: save <seconds> <changes>
save 900 1          # Save after 900 seconds if at least 1 key changed
save 300 10         # Save after 300 seconds if at least 10 keys changed
save 60 10000       # Save after 60 seconds if at least 10000 keys changed

# Compress RDB file when saving
rdbcompression yes
# Checksum RDB file
rdbchecksum yes
# Database filename
dbfilename dump.rdb
# Database directory
dir /data

# ============================================================================
# AOF (Append Only File) - Durability persistence
# ============================================================================
# Enable AOF persistence
appendonly yes
# AOF filename
appendfilename "appendonly.aof"
# fsync policy: always, everysec, no
appendfsync everysec

# Prevent fsync during rewrites
no-appendfsync-on-rewrite no
# AOF rewrite trigger
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
# AOF load truncated
aof-load-truncated yes
# AOF use RDB preamble
aof-use-rdb-preamble yes

# ============================================================================
# MEMORY MANAGEMENT
# ============================================================================
# Maximum memory Redis can use
maxmemory 512mb
# Eviction policy when max memory is reached
# allkeys-lru: Remove any key according to LRU algorithm
maxmemory-policy allkeys-lru
# LRU samples for eviction
maxmemory-samples 5

# ============================================================================
# LAZY FREEING
# ============================================================================
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no
lazyfree-lazy-user-del no

# ============================================================================
# THREADED I/O
# ============================================================================
# Number of I/O threads
io-threads 4
# I/O threads only process reads
io-threads-do-reads no

# ============================================================================
# SECURITY
# ============================================================================
# Require password for connection
# requirepass [password is set via environment variable]
# Master password for privileged commands
# masterauth [master password via environment]

# ACL configuration (Redis 6.0+)
aclfile /etc/redis/users.acl

# ============================================================================
# CLIENTS
# ============================================================================
# Maximum number of connected clients
maxclients 10000

# ============================================================================
# COMMAND RENAMING
# ============================================================================
# Disable dangerous commands for security
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""

# ============================================================================
# REPLICATION
# ============================================================================
# Disable replication (single node setup)
# Uncomment and configure for master-slave replication:
# replicaof <masterip> <masterport>
# replica-read-only yes
# replica-serve-stale-data yes

# ============================================================================
# SLOW LOG
# ============================================================================
# Slow log threshold in microseconds
slowlog-log-slower-than 10000
# Slow log max entries
slowlog-max-len 128

# ============================================================================
# MONITORING
# ============================================================================
# Latency monitoring
latency-monitor-threshold 0

# ============================================================================
# LRU SETTINGS
# ============================================================================
# Clock resolution (milliseconds)
hz 10
# Enable dynamic hz
dynamic-hz yes

# ============================================================================
# ACTIVE REHASHING
# ============================================================================
# Enable active rehashing
activerehashing yes

# ============================================================================
# MODULE LOADING
# ============================================================================
# Load modules at startup (if needed)
# loadmodule /path/to/module.so

# ============================================================================
# ADVANCED CONFIG
# ============================================================================
# Hash slot count (partitions for clustering)
# hash-max-listpack-entries 512
# hash-max-listpack-value 64

# ============================================================================
# COMMAND EXECUTION TIME
# ============================================================================
# Enable command statistics
latency-monitor-threshold 0

# ============================================================================
# PASSIVE DEFRAGMENTATION
# ============================================================================
# Enable active defragmentation
activedefrag no

# Minimum percentage of fragmentation to trigger defragmentation
# active-defrag-ignore-bytes 100mb
# active-defrag-threshold-lower 10

# ============================================================================
# JEMALLOC
# ============================================================================
# Jemalloc configuration (automatically enabled)
# No additional configuration needed for standard setups
